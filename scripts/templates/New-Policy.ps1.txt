[CmdletBinding()]
param (
    [Parameter()]
    [string] $ContainerName = 'stig-policy-store',

    [Parameter(Mandatory)]
    [string] $StorageAcctResourceGroupName,

    [Parameter(Mandatory)]
    [string] $StorageAcctName
)

# Get a SAS URL for the package
# TODO: Get storage account name from some config or from Terraform bootstrap output
$Context = Get-AzStorageContainer -Name $ContainerName -Context (Get-AzStorageAccount -ResourceGroupName $StorageAcctResourceGroupName -Name $StorageAcctName).Context

$StartTime = Get-Date
$EndTime = $StartTime.AddYears(3)

$TokenParams = @{
    StartTime  = $StartTime
    ExpiryTime = $EndTime
    Container  = $ContainerName
    Blob       = '${{PolicyName}}-0.0.1.zip' # Must match the name of the package created in New-Package.ps1
    Permission = 'r' # Read permission
    Context    = $Context.Context
    FullUri    = $true
}
[string]$ContentUri = New-AzStorageBlobSASToken @TokenParams

$MetaData = Get-Content -Path './metadata.jsonc' | ConvertFrom-Json

[string]$Version = $MetaData.version
[string]$Guid = $MetaData.guid

$PolicyConfig = @{
    PolicyId      = $Guid # Must be a GUID. Use the same GUID for a new version of the policy definition.
    DisplayName   = "${{PolicyName}} STIG Configuration"
    Description   = "Audits and applies the ${{PolicyName}} STIG configuration."
    PolicyVersion = $Version

    Platform      = 'Windows'
    Mode          = 'ApplyAndAutoCorrect'

    #LocalContentPath = "./Package/${{PolicyName}}.zip"
    Path          = "./policies/deployIfNotExists"
    # Azure resources
    # - Storage Account
    #ContentUri    = "https://${StorageAcctName}.blob.core.windows.net/stig-policy-store/${{PolicyName}}.zip"
    ContentUri    = $ContentUri
    # - Managed Identity
    #ManagedIdentityResourceId = "" # Not supported for Arc machines
}
New-GuestConfigurationPolicy @PolicyConfig # -ExcludeArcMachines switch might be required (Arc machines don't support User-assigned Managed Identities)

# Deploy the policy to an Azure Management Group