[CmdletBinding()]
param (
    [Parameter()]
    [string] $StorageAccountContainerResourceId
)

$ContainerName = $storageAccountContainerResourceId.split('/')[12]
$StorageAcctResourceGroupName = $storageAccountContainerResourceId.split('/')[4]
$StorageAcctName = $storageAccountContainerResourceId.split('/')[8]

$MetaData = Get-Content -Path './metadata.jsonc' | ConvertFrom-Json
[string]$Version = $MetaData.version

[hashtable]$params = @{
    Name          = "${{PolicyName}}-$Version"
    Configuration = "./this/localhost-$Version.mof"
    Version       = $Version
    Type          = 'AuditAndSet'
    Force         = $true
    Path          = './Package'
}
New-GuestConfigurationPackage @params

# Upload
$Context = (Get-AzStorageAccount -ResourceGroupName $StorageAcctResourceGroupName -Name $StorageAcctName).Context

$blobPararms = @{
    File = "./Package/${{PolicyName}}-${Version}.zip"
    Container = $ContainerName
    Blob = "${{PolicyName}}-${Version}.zip"
    Context = $Context
    StandardBlobTier = 'Hot'
}

Set-AzStorageBlobContent @blobPararms